<% @page_title = @event.title + " - " +  @event.session_start.strftime("%b %e, %Y") %>

<div id="behindthescenes">
<h1>Behind the scenes at <small><%= link_to @event.title + " (" +  @event.session_start.strftime("%b %e, %Y") + ")", event_path(@event.id) %></small></h1>

<h3>Event History</h3>
<table>
  <thead>
    <tr>
      <th>Modified</th>
      <th>Who</th>
      <th>Changed Items</th>
      <th>Operations</th>
    </tr>
  </thead>
  <tbody>
    <%- if @event.versions.blank? -%>
      <tr>
        <td><%= @event.updated_at %></td>
        <td><%= link_to_learner(@event.last_modifier) %></td>
        <td>n/a</td>
        <td><em>current version</em></td>
      </tr>
    <%- else -%>
      <%- @event.versions.reverse.each do |version| -%>
        <tr>
          <td><%= version.created_at %></td>
          <td><%= link_to_learner(Learner.find_by_id(version.whodunnit)) %></td>
          <td><%= version.changeset.keys.join(', ').gsub('presenter_tokens','presenters').gsub('tag_list','tags') %></td>
          <td>
            <%= form_tag(restore_events_path) do %>
            <%= hidden_field_tag 'version', version.id %>
              <%= submit_tag "Restore Previous", {:class => 'btn'} %>              
            <%- end -%>
          </td>
        </tr>
      <%- end -%>
      <tr>
        <td><%= @event.created_at %></td>
        <td><%= link_to_learner(@event.creator) %></td>
        <td>n/a</td>
        <td><em>initially created</em></td>
      </tr>
    <%- end -%>
  </tbody>
</table>

<%- attendee_count = @event.attendees.count -%>
<%- watched_count = @event.watched.count -%>
<%- bookmarked_count = @event.bookmarked.count -%>

<h3>Event up-votes (<%= @event.ratings.count -%>)</h3>

<h3>Comments (<%= @event.comments.count -%>)</h3>

<h3>Questions</h3>
<%- if @event.started? %>
   <%- @event.questions.each do |question| -%>
    <div class="event_question">
        <h5><%= question.prompt %></h5>
        <p><%= question.answer_data.map{|(response,total)| total}.sum %> people answered</p>
        <ul>
        <%- question.answer_data.each do |(response,total)| -%>
          <li><strong><%= total %></strong> "<%= response %>"</li>
        <%- end -%>
        </ul>
    </div>
    <%- end -%>
<%- end -%>


<h3>Connections</h3>
<h4>Attended (<%= attendee_count -%>)</h4>
<%- if attendee_count > 0 -%>
  <ul class="learner_list">
    <%- @event.attendees.each do |attendee| %>
      <li><%= get_avatar(attendee, :thumb, :link_it) -%></li>
    <%- end -%>
  </ul>
<%- else -%>
  <ul class="learner_list">
    <li><span class="empty_avatar"></span></li>
  </ul>
<%- end -%>

<h4>Watched (<%= watched_count -%>)</h4>
<%- if watched_count > 0 -%>
  <ul class="learner_list">
    <%- @event.watched.each do |watcher| %>
      <li><%= get_avatar(watcher, :thumb, :link_it) -%></li>
    <%- end -%>
  </ul>
<%- else -%>
  <ul class="learner_list">
    <li><span class="empty_avatar"></span></li>
  </ul>
<%- end -%>

<h4>Bookmarked (<%= bookmarked_count -%>)</h4>
<%- if bookmarked_count > 0 -%>
  <ul class="learner_list">
    <%- @event.bookmarked.each do |bookmarker| %>
      <li><%= get_avatar(bookmarker, :thumb, :link_it) -%></li>
    <%- end -%>
  </ul>
<%- else -%>
  <ul class="learner_list">
    <li><span class="empty_avatar"></span></li>
  </ul>
<%- end -%>

</div>